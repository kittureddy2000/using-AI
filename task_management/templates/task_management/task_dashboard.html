<!-- task_dashboard.html -->
{% extends 'task_management/task_base.html' %}
{% load static %}
{% block title %}Task Management{% endblock %}
{% block additional_head %}
<meta name="csrf-token" content="{{ csrf_token }}" />
{% endblock %}
{% block content %}

<input type="hidden" id="current-list" />

<div
  id="success-message"
  style="display: none"
  class="alert alert-success"
  role="alert"
></div>

<div class="container-fluid">
  <div class="row">
    <!-- Hamburger Icon for smaller screens Start -->
    <nav class="navbar navbar-expand-lg navbar-light bg-light">
      <div class="col col-auto d-block d-lg-none">
        <button
          class="btn btn-light"
          type="button"
          data-bs-toggle="collapse"
          data-bs-target="#sidebarMenu"
          aria-controls="sidebarMenu"
          aria-expanded="false"
          aria-label="Toggle navigation"
        >
          <i
            class="fas fa-bars text-primary"
            aria-hidden="true"
            style="cursor: pointer"
          ></i>
        </button>
      </div>
    </nav>
    <!-- Hamburger Icon for smaller screens End -->

    <!-- Bootstrap Sidebar Start -->
    <nav id="sidebarMenu" class="col-md-2 d-md-block bg-light collapse">
      <ul class="nav flex-column">
        <!-- Special Lists -->
        {% for tasklist in special_lists %}
          <li class="nav-item">
            <a href="#" class="nav-link task-list-item d-flex" data-id="{{ tasklist.id }}">
              <span class="icon-container me-2">
                {% if tasklist.list_code == "PAST_DUE" %}
                  <i class="fas fa-exclamation-triangle text-danger"></i>
                {% elif tasklist.list_code == "IMPORTANT" %}
                  <i class="fas fa-star text-warning"></i>
                {% elif tasklist.list_code == "ALL_TASKS" %}
                  <i class="fas fa-th-list text-primary"></i>
                {% else %}
                  <i class="fas fa-clipboard-list text-secondary"></i>
                {% endif %}
              </span>
              <span class="text-truncate">{{ tasklist.list_name }}</span>
              {% if tasklist.task_count > 0 %}
                <span class="badge bg-primary rounded-pill ms-2">{{ tasklist.task_count }}</span>
              {% endif %}
            </a>
          </li>
        {% endfor %}

        <!-- Divider after special lists -->
        {% if semi_special_lists or normal_lists %}
          <li class="nav-item">
            <hr class="divider-blue">
          </li>
        {% endif %}

        <!-- Semi-Special Lists (G My Tasks and MS Tasks) -->
        {% for tasklist in semi_special_lists %}
          <li class="nav-item">
            <a href="#" class="nav-link task-list-item d-flex" data-id="{{ tasklist.id }}">
              <span class="icon-container me-2">
                {% if tasklist.list_name == "G My Tasks" %}
                  <i class="fab fa-google text-info"></i>
                {% elif tasklist.list_name == "MS Tasks" %}
                  <i class="fab fa-microsoft text-primary"></i>
                {% else %}
                  <i class="fas fa-tasks text-dark"></i>
                {% endif %}
              </span>
              <span class="text-truncate">{{ tasklist.list_name }}</span>
              {% if tasklist.task_count > 0 %}
                <span class="badge bg-primary rounded-pill ms-2">{{ tasklist.task_count }}</span>
              {% endif %}
            </a>
          </li>
        {% endfor %}

        <!-- Divider after special lists -->
        {% if normal_lists %}
          <li class="nav-item">
            <hr class="divider-blue">
          </li>
        {% endif %}

        <!-- Normal Lists (sorted alphabetically) -->
        {% for tasklist in normal_lists %}
          <li class="nav-item">
            <a href="#" class="nav-link task-list-item d-flex" data-id="{{ tasklist.id }}">
              <span class="icon-container me-2">
                {% if tasklist.list_source == "Google" %}
                  <i class="fab fa-google text-info"></i>
                {% elif tasklist.list_source == "Microsoft" %}
                  <i class="fab fa-microsoft text-primary"></i>
                {% else %}
                  <i class="fas fa-tasks text-dark"></i>
                {% endif %}
              </span>
              <span class="text-truncate">{{ tasklist.list_name }}</span>
              {% if tasklist.task_count > 0 %}
                <span class="badge bg-primary rounded-pill ms-2">{{ tasklist.task_count }}</span>
              {% endif %}
            </a>
          </li>
        {% endfor %}

        <!-- Create List Link -->
        <li class="nav-item task-list-item text-bold">
          <a href="{% url 'task_management:create_task_list' %}" class="nav-link text-dark me-2">
            <i class="fas fa-plus text-primary"></i> Create List
          </a>
        </li>
      </ul>
    </nav>
    <!-- Bootstrap Sidebar End -->

    <main id="task-middle-panel" class="col-md-9">
      <!-- Search row Section Start-->
      <div id="searchbar_row" class="mb-3">
        <div class="d-flex align-items-center flex-nowrap">
          <!-- Search Box: grows to fill available space -->
          <input
            type="text"
            class="form-control flex-grow-1 me-3"
            id="search-task"
            placeholder="Search"
          />
      
          <!-- Add Task Button -->
          <button class="btn btn-light add-task-btn rounded-circle me-3" type="button">
            <i class="fa fa-plus-circle fa-lg text-primary" aria-hidden="true" style="cursor: pointer;"></i>
          </button>
      
          <!-- Filter Dropdown -->
          <div class="d-flex align-items-center me-3">
            <label class="form-label me-2" title="Filter">
              <i class="fas fa-filter fa-lg text-primary"></i>
            </label>
            <select id="filters" class="form-select form-select-sm" style="width: auto;">
              <option value="all">All</option>
              <option value="completed">Completed</option>
              <option value="past_due">Past Due</option>
            </select>
          </div>
      
          <!-- Sort Dropdown -->
          <div class="d-flex align-items-center me-3">
            <label class="form-label me-2" title="Sort By">
              <i class="fas fa-sort fa-lg text-primary"></i>
            </label>
            <select id="sort-by" class="form-select form-select-sm" style="width: auto;">
              <option value="">No Sort</option>
              <option value="due_date">Due Date</option>
              <option value="important">Important</option>
            </select>
          </div>
      
          <!-- Sync Button -->

          <button id="manual-sync-btn" class="btn btn-outline-primary d-flex align-items-center">
            <i class="fas fa-sync-alt me-2"></i>
            Sync
          </button>

        </div>
      </div>
      
      <!-- Search row Section End -->

      <!-- Task Cards Section -->
      <section id="tasks-section">
        <div id="sync-status" class="d-none alert alert-info" style="margin-top: 10px;">
          Syncing tasks... <i class="fas fa-spinner fa-spin"></i>
        </div>
        <!-- Task cards will be dynamically inserted here -->
      </section>
    </main>

    <!-- Task Details Section -->
    <div id="task-details-panel" class="col-md-4 bg-light d-none">
      <!-- Task details will be loaded here -->
    </div>
    <!-- Back button visible only on small screens, outside the task-details-panel -->
    <button id="back-button" class="btn btn-secondary d-none mb-3">
      <i class="fas fa-arrow-left"></i> Back
    </button>
  </div>

  <!-- Task Modal -->
  <div
    class="modal fade"
    id="taskModal"
    tabindex="-1"
    role="dialog"
    aria-labelledby="taskModalLabel"
    aria-hidden="true">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="taskModalLabel">Add Task</h5>
          <button
            type="button"
            class="close"
            data-bs-dismiss="modal"
            aria-label="Close"
          >
            <span aria-hidden="true">×</span>
          </button>
        </div>
        <div class="modal-body">
          <!-- Form content will be loaded here -->
        </div>
        <div class="modal-footer">
          <button
            type="button"
            class="btn btn-secondary"
            data-bs-dismiss="modal"
          >
            Close
          </button>
          <button
            type="button"
            class="btn btn-primary"
            data-bs-dismiss="modal"
            id="saveTask"
          >
            Save
          </button>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block script_block %}
<script>
  // Function to sync Google Tasks
  function syncGoogleTasks() {
    var csrfToken = $('meta[name="csrf-token"]').attr("content");
    console.log("Dashboard HTML : syncGoogleTasks function called");
    fetch("/task_management/sync_google_tasks/", {
      method: 'GET',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': csrfToken
      }
    })
    .then((response) => {
      if (!response.ok) {
        console.log("Dashboard HTML : syncGoogleTasks: Response Status : " + response.status);
        return response.json().then(data => {
          console.error("Dashboard HTML : syncGoogleTasks: Error syncing tasks:", data.error);
          if (response.status === 400) {
            console.error("Dashboard HTML : syncGoogleTasks: User not authenticated");
            return;
          }
          throw new Error(data.error || "Failed to sync tasks.");
        });
      }
      return response.json();
    })
    .then((data) => {
      if (data) {
        console.log("Dashboard HTML : syncGoogleTasks: Sync Task Success " + data.message);
        $("#success-message").text(data.message).fadeIn();
        setTimeout(function () {
          $("#success-message").fadeOut();
        }, 3000);
        fetchTasksFromDb(); // Refresh the task table after success.
        updateBadgeCounts(); // Update badges after sync
      }
    })
    .catch((error) => {
      console.error("Dashboard HTML : syncGoogleTasks: Error syncing tasks:", error);
    })
    .finally(() => {
      $("#sync-status").fadeOut(); // Hide sync status on completion or error
    });
  }

  // Function to sync Microsoft Tasks
  function syncMSTasks() {
    var csrfToken = $('meta[name="csrf-token"]').attr("content");

    fetch("/task_management/sync_microsoft_tasks/", {
      method: 'GET',
      headers: {
        'X-CSRFToken': csrfToken,
        'Content-Type': 'application/json'
      }
    })
    .then((response) => {
      if (!response.ok) {
        return response.json().then(data => {
          if (data.error === "Microsoft account not connected." || data.error === "Authentication failed. Please reconnect your Microsoft account.") {
            window.location.href = "/task_management/connect_microsoft/";
          } else {
            console.error("Error response:", data);
            throw new Error(data.error || "Failed to sync tasks.");
          }
        });
      }
      return response.json();
    })
    .then((data) => {
      if (data.message) {
        console.log("MS Tasks Sync:", data.message);
        $("#success-message").text(data.message).fadeIn();
        setTimeout(function () {
          $("#success-message").fadeOut();
        }, 3000);
        fetchTasksFromDb();
        updateBadgeCounts(); // Update badges after sync
      } else {
        console.error("MS Tasks Sync: No message in response");
      }
    })
    .catch((error) => {
      console.error("Error syncing MS tasks:", error);
    })
    .finally(() => {
      $("#sync-status").fadeOut(); // Hide sync status on completion or error
    });
  }

  function createTaskCardHTML(task) {
    const overdueSpan = task.overdue ? `<span class="text-danger">Overdue</span>` : '';
    const taskNameClass = task.task_completed ? 'strikethrough' : '';
    const completeIconClass = task.task_completed ? 'text-danger' : 'text-success';
    const favoriteIconClass = task.important ? 'fa-solid text-primary' : 'fa-regular';
    return `
      <div class="card task-card mb-1" data-task-id="${task.id}" id="task-${task.id}">
        <div class="card-body p-2 d-flex align-items-center">
          <i id="completeicon-${task.id}" class="fa-solid fa-circle-check fa-lg complete-task me-3 ${completeIconClass}" style="cursor: pointer;" data-id="${task.id}"></i>
          <div class="task-info flex-grow-1">
            <h6 class="task-name ${taskNameClass}">${task.task_name}</h6>
            <p class="task-due-date text-muted mb-0">
              <i class="fas fa-calendar-alt me-1"></i>
              ${overdueSpan}
              ${formatDate(task.due_date)}
            </p>
          </div>
          <i id="favorite-icon-${task.id}" class="fa-star mark-favorite ms-auto ${favoriteIconClass}" style="cursor: pointer;" data-id="${task.id}"></i>
        </div>
      </div>`;
  }

  function updateTasksSection(tasks) {
    const tasksHtml = tasks.map((task) => createTaskCardHTML(task)).join("");
    if (tasks.length === 0) {
      $("#tasks-section").html(`
        <div class="alert alert-info text-center" role="alert">
          No tasks available. Check your Google Tasks or Microsoft To Do accounts for tasks, 
          or <a href="#" id="manual-sync-btn">sync manually</a> to refresh.
        </div>
      `);
    } else {
      $("#tasks-section").html(tasksHtml || '<p>No tasks available or loading failed—try refreshing.</p>');
    }
  }

  function showLoading() {
    $("#tasks-section").html('<div class="loading-spinner">Loading tasks...</div>');
  }

  function fetchTasksFromDb() {
    console.log("Task Dashboard: Fetching tasks from DB");
    showLoading(); // Show loading spinner
    fetch("/task_management/get_all_tasks/", { timeout: 5000 })
      .then((response) => {
        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
        return response.json();
      })
      .then((data) => {
        console.log("Task Dashboard: Tasks fetched from DB");
        updateTasksSection(data.tasks);
      })
      .catch((error) => {
        console.error("Error fetching tasks from DB:", error);
        updateTasksSection([]); // Show empty state with enhanced message
        $("#tasks-section").append('<p>Tasks failed to load—please refresh or try later.</p>');
      })
      .finally(() => {
        $("#sync-status").fadeOut(); // Hide sync status on completion or error
      });
  }

  function triggerAsyncSync() {
    var csrfToken = $('meta[name="csrf-token"]').attr("content");
    console.log(`Triggering async Process for all tasks`);
    $("#sync-status").removeClass("d-none").text(`Syncing tasks... <i class="fas fa-spinner fa-spin"></i>`).fadeIn();
    fetch("/task_management/trigger_user_sync/", {  // Updated to trigger_user_sync for user-specific sync
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': csrfToken
      }
    })
    .then((response) => {
      if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
      return response.json();
    })
    .then((data) => {
      console.log(`All syncs enqueued:`, data.message);
      $("#sync-status").text(`Syncing tasks in background...`).fadeIn();
      setTimeout(() => {
        $("#sync-status").fadeOut();
        fetchTasksFromDb(); // Refresh tasks after sync
        updateBadgeCounts(); // Refresh badges after sync
      }, 5000);
    })
    .catch((error) => {
      console.error(`Error triggering sync:`, error);
      $("#sync-status").text(`Sync failed—please try again.`).removeClass("alert-info").addClass("alert-danger");
      setTimeout(() => $("#sync-status").fadeOut(), 5000);
    });
  }

  // Function to update badge counts
  function updateBadgeCounts() {
    $.ajax({
      url: "{% url 'task_management:get_task_counts' %}",
      type: "GET",
      dataType: "json",
      success: function (response) {
        const counts = response.counts;
        $('.task-list-item').each(function () {
          const listId = $(this).data('id');
          const count = counts[listId] || 0;
          const badge = $(this).find('.badge');
          if (count > 0) {
            if (badge.length) {
              badge.text(count); // Update existing badge
            } else {
                $(this).append(`<span class="badge bg-primary">${count}</span>`);
            }
          } else {
            badge.remove(); // Remove badge if count is 0
          }
        });
      },
      error: function (xhr, status, error) {
        console.error("Error fetching task counts: " + error);
      }
    });
  }

  $(document).ready(function () {
    console.log("Dashboard HTML : In Document Ready Function");
    const userId = {{ user.id }};

    // Call fetchTasksFromDb function to fetch tasks from the database
    fetchTasksFromDb();

    // Trigger async syncs for all tasks in the background (single call)
    triggerAsyncSync();

    // Optional: Add a manual sync button for users (already in HTML as #manual-sync-btn)
    $("#manual-sync-btn").on("click", function(e) {
      e.preventDefault();
      triggerAsyncSync();
    });

    // Handle clicking on a task category in the sidebar
    $(".task-list-item").click(function () {
      var listId = $(this).data("id");
      console.log("list Id : " + listId);
      $("#current-list").data("list-id", listId);
      $(".task-list-item").removeClass("highlighted");
      this.classList.add("highlighted");

      $.ajax({
        url: `/task_management/get_tasks_by_list/${listId}`,
        type: "GET",
        dataType: "json",
        success: function (response) {
          console.log("Received data:", response);
          updateTasksSection(response.tasks);
          $("#task-details-panel").addClass("d-none");

          if (window.innerWidth < 768) {
            var sidebarMenu = $("#sidebarMenu");
            var bsCollapse = new bootstrap.Collapse(sidebarMenu, {
              toggle: true,
            });
            bsCollapse.hide();
          }
        },
        error: function (xhr, status, error) {
          console.error("An error occurred while fetching tasks: " + error);
        }
      });
    });

    // Handle clicking on a task card to show details
    $(document).on("click", ".task-card", function () {
      var taskId = $(this).data("task-id");
      console.log("Clicked on task row with Task Id : " + taskId);

      url = "{% url 'task_management:edit_task' 999 %}".replace("999", taskId);

      $.ajax({
        url: url,
        type: "GET",
        success: function (tasks) {
          console.log("In Success message for getting edit_task_panel");
          $("#task-details-panel").removeClass("d-none");
          $("#task-details-panel").html(tasks);
          document.getElementById("task-middle-panel").classList.remove("col-md-9");
          document.getElementById("task-middle-panel").classList.add("col-md-6");

          if ($(window).width() < 768) {
            $("#tasks-section").toggleClass("d-none");
            $("#back-button").removeClass("d-none");
            $("#searchbar_row").addClass("d-none");
          }
        },
        error: function (xhr, status, error) {
          console.log("Error fetching task details:", xhr.status);
        },
      });
    });

    // Handle completing a task
    $(document).on("click", ".complete-task", function (e) {
      var taskId = $(this).data("id");
      var taskRow = $("#task-" + taskId);
      var csrfToken = $('meta[name="csrf-token"]').attr("content");
      console.log("Task_id : " + taskId);

      $.ajax({
        url: "{% url 'task_management:complete_task' %}",
        type: "POST",
        data: {
          id: taskId,
          csrfmiddlewaretoken: csrfToken,
        },
        success: function (response) {
          console.log("Clicked Complete : " + response.task_name);
          console.log("Task Id : " + response.task_id);

          if (response.task_completed) {
            $(`#task-${response.task_id} .card-text:first`).addClass("strikethrough");
          } else {
            $(`#task-${response.task_id} .card-text:first`).removeClass("strikethrough");
          }

          $(`#task-${response.task_id} .complete-task`).toggleClass("text-danger text-success");

          $("#success-message").text("Marked task Complete: " + response.task_name).show();
          setTimeout(function () {
            $("#success-message").hide();
          }, 1000);
          updateBadgeCounts(); // Update badges after task completion
        },
        error: function (xhr, status, error) {
          console.error("Error in AJAX request:", status, error);
        },
      });
    });

    // Handle marking a task as favorite/important
    $(document).on("click", ".mark-favorite", function (e) {
      var taskId = $(this).data("id");
      var csrfToken = $('meta[name="csrf-token"]').attr("content");
      console.log("Mark Favorite Task_id : " + taskId);

      $.ajax({
        url: "{% url 'task_management:mark_favorite' %}",
        type: "POST",
        data: {
          id: taskId,
          csrfmiddlewaretoken: csrfToken,
        },
        success: function (response) {
          var iconClass = response.Important ? "fa-sharp fa-solid fa-star" : "fa-sharp fa-regular fa-star";

          $("#favorite-icon-" + response.task_id).attr("class", iconClass);

          $("#success-message").text("Marked task as important: " + response.task_name).show();
          setTimeout(function () {
            $("#success-message").hide();
          }, 5000);
          updateBadgeCounts(); // Update badges after marking as favorite
        },
        error: function (xhr, status, error) {
          console.error("Error in AJAX request:", status, error);
        },
      });
    });

    // Handle clicking the add task button
    $(document).on("click", ".add-task-btn", function () {
      var listId = $("#current-list").data("list-id");
      if (listId === undefined) {
        listId = 1;
      }
      console.log("listid in Add Task Form : " + listId);
      $("#taskModal").data("mode", "add");
      console.log(" Task Model Mode in Create mode ");
      $("#taskModal .modal-body").load("/task_management/add/" + listId, function () {
        $("#taskModal").modal("show");
      });
    });

    // Handle saving a task (create/edit)
    $("#saveTask").click(function () {
      console.log("Saving Task function called");
      var mode = $("#taskModal").data("mode");
      var taskId = $("#taskModal").data("taskId");
      var url = mode === "edit" ? `/task_management/edit_task/${taskId}/` : "/task_management/add/1/";
      var formData = new FormData($("#taskModal form")[0]);

      $.ajax({
        url: url,
        type: "POST",
        data: formData,
        processData: false,
        contentType: false,
        success: function (response) {
          console.log("Success in Ajax Save Task");
          var newTask = response.new_task || response; // Handle add/edit response
          addNewTasktoDisplay(newTask);

          if ($(window).width() < 768) {
            $("#task-details-panel").addClass("d-none");
          }

          setTimeout(function () {
            $("#taskModal").modal("hide");
          }, 500);

          // Update badge counts after adding the task
          updateBadgeCounts();
        },
        error: function (xhr, status, error) {
          console.log("Ajax error in Save Task: " + error);
        },
      });
    });

    // Handle searching tasks
    function doSearch() {
      console.log("Java Script : In doSearch Function ");
      const query = document.getElementById("search-task").value;
      const filter = document.getElementById("filters").value;
      const sortBy = document.getElementById("sort-by").value;

      console.log("Query : " + query);
      console.log("Filter : " + filter);
      console.log("Sort By : " + sortBy);

      const url = new URL(window.location.origin + "{% url 'task_management:search_tasks' %}");
      url.searchParams.set("q", query);
      if (filter) url.searchParams.set("filter", filter);
      if (sortBy) url.searchParams.set("sort_by", sortBy);

      console.log("URL : " + url);

      $.ajax({
        url: url,
        dataType: "json",
        success: function (response) {
          console.log("Received Search data:", response);

          if (response.tasks.length === 0) {
            $("#tasks-section").html("<p>No tasks found.</p>");
          } else {
            updateTasksSection(response.tasks);
          }
        },
        error: function (xhr, status, error) {
          console.error("Error occurred: " + error);
        },
      });
    }

    document.getElementById("search-task").addEventListener("input", doSearch);
    document.getElementById("filters").addEventListener("change", doSearch);
    document.getElementById("sort-by").addEventListener("change", doSearch);

    // Handle submitting the edit task form in the panel
    $(document).on("submit", "#edit-task-form", function (e) {
      console.log("Edit Task Save function called from Side Panel");
      e.preventDefault();
      var taskId = $(this).data("task-id");
      url = "/task_management/edit_task/" + taskId + "/";

      var formData = new FormData(this);
      var taskHtml = "";
      $.ajax({
        url: url,
        type: "POST",
        data: formData,
        processData: false,
        contentType: false,
        success: function (response) {
          console.log("edit-task-form Ajax : Success from Save Task : " + response.task_name);
          console.log("edit-task-form Ajax : Task ID : " + response.id);
          const taskHtml = createTaskCardHTML(response);
          $("#task-" + response.id).replaceWith(taskHtml);
          $("#task-details-panel").addClass("d-none");
          $("#task-middle-panel").removeClass("col-md-6");
          $("#task-middle-panel").addClass("col-md-9");
          updateBadgeCounts(); // Update badges after editing a task
        },
        error: function (xhr, status, error) { },
      });
    });

    // Handle clicking the back button
    $("#back-button").on("click", function () {
      $("#task-details-panel").addClass("d-none");
      $("#tasks-section").toggleClass("d-none");
      $("#back-button").addClass("d-none");
      $("#searchbar_row").removeClass("d-none");
    });

    // Add new task to display
    function addNewTasktoDisplay(newTask) {
      const newTaskHtml = createTaskCardHTML(newTask);
      $("#tasks-section").append(newTaskHtml);
    }

    // Sync Google Tasks button
    $(document).on("click", "#sync-goog-tasks-btn", function (e) {
      console.log("Sync Task button clicked");
      syncGoogleTasks();
    });

    // Sync Microsoft Tasks button
    $(document).on("click", "#sync-ms-tasks-btn", function () {
      syncMSTasks();
    });

    // Handle manual sync link in empty state
    $("#tasks-section").on("click", "#manual-sync-btn", function(e) {
      e.preventDefault();
      triggerAsyncSync();
    });
  });
</script>
<script src="{% static 'task_management/scripts/task_management-script.js' %}"></script>
{% endblock %}