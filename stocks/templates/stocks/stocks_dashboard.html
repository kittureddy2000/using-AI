{% extends 'stocks/stocks_base.html' %}
{% load static %}
{% load custom_filters %}
{% load crispy_forms_tags %}

{% block title %}Stocks Dashboard{% endblock %}
{% block header %}<h4>Stocks Dashboard</h4>{% endblock %}

{% block content %}
<div class="container mt-5">
    <div class="row mb-4">
        <div class="col">
            <input type="text" id="stockSearchInput" class="form-control" placeholder="Search stocks...">
        </div>
        <!-- Add the refresh button in a new column -->
        <div class="col-auto">
            <a href="{% url 'stocks:stock_list' %}" class="btn btn-light" id="refreshStocks" title="Refresh Stocks">
                <i class="fas fa-sync-alt"></i> Refresh
            </a>
        </div>
        <div class="col-auto">
            <a href="{% url 'stocks:add_stock' %}" class="btn btn-light" title="Add a New Stock">
                <i class="fas fa-plus"></i> Add Stock
            </a>
        </div>
    </div>

    <div class="table-responsive">
        <table class="table table-hover" id="stocksTable">
            <thead class="table-primary">
                <tr>
                    <th scope="col">#</th>
                    <th scope="col">Symbol</th>
                    <th scope="col">Quantity</th>
                    <th scope="col">Current Price</th>
                    <th scope="col">Purchase Price</th>
                    <th scope="col">52 Week Low</th>
                    <th scope="col">52 Week High</th>
                    <th scope="col">Market Cap</th>
                    <th scope="col">Dividend Rate</th>
                    <th scope="col">Name</th>
                </tr>
            </thead>
            <tbody>
                {% for stock in stock_list %}
                    <tr>
                        <th scope="row">{{ forloop.counter }}</th>
                        <td class="stock-symbol">{{ stock.symbol }}</td>
                        <td>{{ stock.quantity }}</td>
                        <td>{{ stock.currentPrice|nan_to_blank }}</td>
                        <td>{{ stock.purchase_price }}</td>
                        <td>{{ stock.fiftyTwoWeekLow|nan_to_blank }}</td>
                        <td>{{ stock.fiftyTwoWeekHigh|nan_to_blank }}</td>
                        <td>{{ stock.marketCap|millions|nan_to_blank }}</td>
                        <td>{{ stock.dividendRate|nan_to_blank }}</td>
                        <td class="stock-name">{{ stock.shortName }}</td>
                    </tr>
                {% empty %}
                    <tr>
                        <td colspan="10" class="text-center">No stocks found</td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endblock %}

{% block script_block %}
<script>
  document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('stockSearchInput');
    const table = document.getElementById('stocksTable');
    const tbody = table.querySelector('tbody');

    searchInput.addEventListener('keyup', function() {
      const query = searchInput.value.trim().toLowerCase();
      const rows = tbody.querySelectorAll('tr');

      rows.forEach((row) => {
        const symbolCell = row.querySelector('.stock-symbol');
        const nameCell = row.querySelector('.stock-name');
        if (!symbolCell || !nameCell) return;

        const symbolText = symbolCell.textContent.toLowerCase();
        const nameText = nameCell.textContent.toLowerCase();

        if (symbolText.includes(query) || nameText.includes(query)) {
          row.style.display = '';
        } else {
          row.style.display = 'none';
        }
      });
    });
  });
</script>
{% endblock %}
