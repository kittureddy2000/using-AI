{% load todo_extras %}
<!-- Load custom template tags, if any -->

<form method="post" id="edit-task-form" data-task-id="{{ task_id }}" enctype="multipart/form-data">
    <!-- Main form to manage tasks -->
    {% csrf_token %}
    <!-- Django's CSRF token for security -->
    {{ edit_task_form.non_field_errors }}
    <!-- Display any form errors that are not related to a specific field -->

    <!-- Task Name -->
    <div>
        {{ edit_task_form.task_name|add_class:"form-control mb-1 input-box" }}
        <!-- Task name field using Django's form rendering with Bootstrap classes -->
        {{ edit_task_form.task_name.errors }}
        <!-- Display any errors related to the task name field -->
    </div>

    <!-- Due Date -->
    <div class="card">
        <!-- Card container for styling -->
        <div class="card-body">
            <!-- Card body for padding and content -->
            <i class="fas fa-calendar-alt form-icon"></i>
            <!-- Calendar icon -->
            <label class="form-label dropdown-toggle" id="dueDateDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                <!-- Label for due date dropdown -->
                Due Date
                <span id="dueDateLabel" class="ms-2">
                    <!-- Span to hold formatted due date -->
                    {% if edit_task_form.due_date.value %}
                    {{ edit_task_form.due_date.value|date:"D, M j, Y" }}
                    {% endif %}
                    <!-- Initial date set by Django template tag -->
                </span>
            </label>
            <ul class="dropdown-menu" aria-labelledby="dueDateDropdown">
                <!-- Dropdown menu for due date options -->
                <li><a class="dropdown-item due-date-option" data-value="today" href="#">Today</a></li>
                <li><a class="dropdown-item due-date-option" data-value="tomorrow" href="#">Tomorrow</a></li>
                <li><a class="dropdown-item due-date-option" data-value="next_week" href="#">Next Week</a></li>
                <li><a class="dropdown-item due-date-option" data-value="pick_date_time" href="#">Pick a date</a></li>
            </ul>
             <input type="text" class="d-none date-picker" id="dueDateInput" name="due_date" value="{{ edit_task_form.due_date.value|date:'Y-m-d' }}">
             <!-- Hidden input for due date, value pre-filled by Django in 'YYYY-MM-DD' format -->
         </div>
    </div>

    <!-- Reminder Time -->
    <div class="card">
         <!-- Card container for styling -->
        <div class="card-body">
             <!-- Card body for padding and content -->
            <i class="fas fa-bell form-icon"></i>
            <!-- Bell icon -->
             <label class="form-label dropdown-toggle" id="reminderDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                <!-- Label for reminder time dropdown -->
                Remind me at
                <span id="reminderTimeLabel" class="ms-2">
                    <!-- Span to hold formatted reminder time -->
                    {% if edit_task_form.reminder_time.value %}
                        {{ edit_task_form.reminder_time.value|date:"D, M j, Y" }}
                    {% endif %}
                    <!-- Initial time set by Django template tag -->
                </span>
            </label>
           <ul class="dropdown-menu" aria-labelledby="reminderDropdown">
                <!-- Dropdown menu for reminder time options -->
                <li><a class="dropdown-item reminder-option" data-value="later_today" href="#">Later Today, 11:00PM</a></li>
                <li><a class="dropdown-item reminder-option" data-value="tomorrow" href="#">Tomorrow, 9:00AM</a></li>
                <li><a class="dropdown-item reminder-option" data-value="next_week" href="#">Next Week, Monday 9:00AM</a></li>
                <li><a class="dropdown-item reminder-option" data-value="pick_date_time" href="#">Pick a date</a></li>
            </ul>
            <input type="text" class="d-none date-picker" id="reminderInput" name="reminder_time" value="{{ edit_task_form.reminder_time.value|date:'Y-m-d' }}">
              <!-- Hidden input for reminder time, value pre-filled by Django in 'YYYY-MM-DD' format -->
        </div>
    </div>

    <!-- Recurrence -->
    <div class="card">
        <!-- Card container for styling -->
        <div class="card-body">
        <!-- Card body for padding and content -->
            <i class="fas fa-redo form-icon"></i>
             <!-- Redo icon -->
            <label class="form-label dropdown-toggle" id="recurrenceDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                <!-- Label for recurrence dropdown -->
                Repeat
                <span id="recurrenceLabel" class="ms-2">
                    <!-- Span to hold formatted recurrence option -->
                    {% if edit_task_form.recurrence.value %}
                    {% for choice in edit_task_form.recurrence.field.choices %}
                    {% if choice.0 == edit_task_form.recurrence.value %}
                    {{ choice.1 }}
                    {% endif %}
                    {% endfor %}
                    {% endif %}
                      <!-- Initial value set by Django template tag -->
                </span>
            </label>
            <ul class="dropdown-menu" aria-labelledby="recurrenceDropdown">
                 <!-- Dropdown menu for recurrence options -->
                {% for choice in edit_task_form.recurrence.field.choices %}
                <li><a class="dropdown-item recurrence-option" data-value="{{ choice.0 }}" href="#">{{ choice.1 }}</a></li>
                {% endfor %}
            </ul>
            <input type="hidden" name="recurrence" id="recurrenceInput" value="{{ edit_task_form.recurrence.value }}">
            <!-- Hidden input for recurrence, value pre-filled by Django -->
        </div>
    </div>

    <!-- List Name -->
    <div class="card">
         <!-- Card container for styling -->
        <div class="card-body">
        <!-- Card body for padding and content -->
            <i class="fas fa-list-ul form-icon"></i>
             <!-- list icon -->
            <label class="form-label dropdown-toggle" id="listNameDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                 <!-- Label for list name dropdown -->
                List Name
                <span id="listNameLabel" class="ms-2">
                     <!-- Span to hold formatted list name option -->
                    {% if edit_task_form.list_name.value %}
                    {% for choice in edit_task_form.list_name.field.choices %}
                    {% if choice.0 == edit_task_form.list_name.value %}
                    {{ choice.1 }}
                    {% endif %}
                    {% endfor %}
                    {% endif %}
                       <!-- Initial value set by Django template tag -->
                </span>
            </label>
            <ul class="dropdown-menu" aria-labelledby="listNameDropdown">
                <!-- Dropdown menu for list name options -->
                {% for choice in edit_task_form.list_name.field.choices %}
                <li><a class="dropdown-item list-name-option" data-value="{{ choice.0 }}" href="#">{{ choice.1 }}</a></li>
                {% endfor %}
            </ul>
            <input type="hidden" name="list_name" id="listNameInput" value="{{ edit_task_form.list_name.value }}">
            <!-- Hidden input for list name, value pre-filled by Django -->
        </div>
    </div>

    <!-- Images Section -->
    <div class="card">
          <!-- Card container for styling -->
        <div class="card-body">
        <!-- Card body for padding and content -->
            {% if images %}
            <div class="mb-3">
                <!-- Section for existing images -->
                <label class="form-label">Current Images</label>
                 <!-- Label for images -->
                <div class="file-list">
                     <!-- List of current images -->
                    {% for image in images %}
                    <div class="file-item">
                        <i class="fas fa-file-image"></i>
                         <!-- Image icon -->
                        <a href="{{ image.image_url|quote }}" target="_blank">{{ image.image_name }}</a>
                         <!-- Link to view each image -->
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
            <div class="mb-3">
                 <!-- Section for new images -->
                <label class="form-label">File</label>
                <!-- Label for file upload -->
                <input type="file" name="images" id="images" multiple class="form-control">
                   <!-- File upload input -->
            </div>
            <div id="image-previews" class="image-preview"></div>
              <!-- Placeholder for image previews -->
        </div>
    </div>

    <!-- Task Description -->
    <div>
        {{ edit_task_form.task_description|add_class:"form-control expandable input-box" }}
        <!-- Task description textarea -->
        {{ edit_task_form.task_description.errors }}
         <!-- Display any errors related to the task description -->
    </div>

    <!-- Submit Button -->
    <div class="d-flex justify-content-center mt-4">
         <!-- Container for submit button -->
        <button type="submit" class="save-button">
            <!-- Button to submit the form -->
            <i class="fas fa-save"></i>Save
             <!-- Button icon and text -->
        </button>
    </div>
</form>

<script>
    $(document).ready(function () {
        // jQuery's document.ready function, ensures the code inside runs once the DOM is fully loaded


    // Initialize jQuery UI Datepicker for Due Date
        $('#dueDateInput').datepicker({
             // Initialize jQuery UI Datepicker on #dueDateInput element
             onSelect: function (dateText) {
                // The function will get executed when the user select the date in datepicker
                console.log("DueDate onSelect: dateText before new Date()", dateText);

                 $('#dueDateInput').val(dateText);
                // Sets the value of the #dueDateInput to selected value
                const selectedDate = new Date(dateText); // Create a Date object
                var formattedDate =  $.datepicker.formatDate('D, M dd yy', new Date(selectedDate));

                 $('#dueDateLabel').text(formattedDate);
                 console.log("DueDate onSelect: dateText after new Date()", formattedDate);

                // Sets the content of the #dueDateLabel to a formatted date using jQuery UI's date formatting function
                //  $('#dueDateInput').addClass('d-none');
                // Adds "d-none" class to hide the #dueDateInput again

            },
            beforeShow: function(input, inst) {
                //beforeShow option in the jQuery UI Datepicker to execute a function before displaying datepicker
               // Show datepicker only when 'pick_date_time' is selected
               if($('#dueDateInput').hasClass('d-none'))
                    //Checks if #dueDateInput already has a d-none class.
                     return false;
                    // Returns false to prevent the jQuery datepicker from showing
            }
        });
    // Initialize jQuery UI Datepicker for Reminder
           $('#reminderInput').datepicker({
             // Initialize jQuery UI Datepicker on #reminderInput element
                onSelect: function (dateText) {
                   // The function will get executed when the user select the date in datepicker
                    $('#reminderInput').val(dateText);
                    // Sets the value of the #reminderInput to selected value
                    $('#reminderTimeLabel').text($.datepicker.formatDate('D, M dd yy', new Date(dateText)));
                     // Sets the content of the #reminderTimeLabel to a formatted date using jQuery UI's date formatting function
                    //  $('#reminderInput').addClass('d-none');
                     // Adds "d-none" class to hide the #reminderInput again
                },
                beforeShow: function(input, inst) {
                    //beforeShow option in the jQuery UI Datepicker to execute a function before displaying datepicker
                    // Show datepicker only when 'pick_date_time' is selected
                    if($('#reminderInput').hasClass('d-none'))
                         //Checks if #reminderInput already has a d-none class.
                        return false;
                         // Returns false to prevent the jQuery datepicker from showing
            }
        });


        function handleDropdownClick(selector, inputSelector, labelSelector) {
             // Function to handle clicks on dropdown items and update labels and inputs
             $(document).on('click', selector, function (e) {
                // Event listener to capture click event on the element
                e.preventDefault();
                // Prevents default behavior of the clicked element
                const selectedValue = $(this).data('value');
                // Gets the value from the data-value attribute of clicked element
                const selectedText = $(this).text();
                 // Gets the text of the clicked element

                if (selectedValue === 'pick_date_time') {
                     // checks if the clicked dropdown option's value is pick_date_time
                    $(inputSelector).removeClass('d-none').focus();
                      // Remove the "d-none" class from the input field to display the element and give it focus
                }
                 else {
                      // Checks if the clicked dropdown option's value is not pick_date_time
                    $(labelSelector).text(selectedText);
                     // Sets text of the label to the selected option from dropdown
                    $(inputSelector).val(selectedValue);
                     // Sets value of the input element to selected option from dropdown
                    if (!$(inputSelector).hasClass('d-none')) {
                         //Check if input field doesnt have d-none class
                        $(inputSelector).addClass('d-none');
                        // Adds d-none class to the input element to hide it
                    }
                }
                 if(selectedValue == "today"){
                     // Check if selected dropdown option value is today
                     let date = new Date();
                     // Create new date object
                     const year = date.getFullYear();
                     // Gets the full year
                    const month = String(date.getMonth() + 1).padStart(2, '0');
                    // Gets the month and format it to two digit string
                     const day = String(date.getDate()).padStart(2, '0');
                    // Gets the day and format it to two digit string
                    let formattedDate = `${year}-${month}-${day}`;
                    // format the year, month and day in YYYY-MM-DD format
                    $('#dueDateInput').val(formattedDate);
                    // Set the value of the input element to formatted date
                     $('#dueDateLabel').text($.datepicker.formatDate('D, M dd yy', new Date(formattedDate)));
                    //  Set the text of the label to formatted date using Jquery UI date format

                  }
                if(selectedValue == "tomorrow"){
                   // Check if selected dropdown option value is tomorrow
                     let date = new Date();
                     // Create new date object
                     date.setDate(date.getDate() + 1);
                     // Sets the date to tomorrow by adding 1
                     const year = date.getFullYear();
                     // Gets the full year
                     const month = String(date.getMonth() + 1).padStart(2, '0');
                      // Gets the month and format it to two digit string
                     const day = String(date.getDate()).padStart(2, '0');
                     // Gets the day and format it to two digit string
                    let formattedDate = `${year}-${month}-${day}`;
                   // format the year, month and day in YYYY-MM-DD format
                    $('#dueDateInput').val(formattedDate);
                    // Set the value of the input element to formatted date
                    $('#dueDateLabel').text($.datepicker.formatDate('D, M dd yy', new Date(formattedDate)));
                  //  Set the text of the label to formatted date using Jquery UI date format
                  }
                  if(selectedValue == "next_week"){
                    // Check if selected dropdown option value is next week
                     let date = new Date();
                     // Create new date object
                       const dayOfWeek = date.getDay();
                       // Gets the day of the week (0 for Sunday, 1 for Monday etc)
                       const daysUntilMonday = (1 - dayOfWeek + 7) % 7;
                       //Calculate number of days until Monday
                       date.setDate(date.getDate() + daysUntilMonday);
                       // Sets the date to next Monday
                     const year = date.getFullYear();
                      // Gets the full year
                     const month = String(date.getMonth() + 1).padStart(2, '0');
                     // Gets the month and format it to two digit string
                     const day = String(date.getDate()).padStart(2, '0');
                    // Gets the day and format it to two digit string
                     let formattedDate = `${year}-${month}-${day}`;
                      // format the year, month and day in YYYY-MM-DD format
                    $('#dueDateInput').val(formattedDate);
                    // Set the value of the input element to formatted date
                    $('#dueDateLabel').text($.datepicker.formatDate('D, M dd yy', new Date(formattedDate)));
                    // Set the text of the label to formatted date using Jquery UI date format

                  }
                if(selectedValue == "later_today"){
                   // Check if selected dropdown option value is later today
                     let date = new Date();
                    // Create new date object
                    let formattedDate =  $.datepicker.formatDate('yy-mm-dd', new Date(date.getFullYear(), date.getMonth(), date.getDate()));
                     // format the date to YYYY-MM-DD
                    $('#reminderInput').val(formattedDate);
                     // Sets value of the reminder input to formatted date
                    $('#reminderTimeLabel').text($.datepicker.formatDate('D, M dd yy', new Date(formattedDate)));
                     // Set the text of the label to formatted date using Jquery UI date format
                }
                 if(selectedValue == "tomorrow"){
                    // Check if selected dropdown option value is tomorrow
                    let date = new Date();
                     // Create new date object
                     date.setDate(date.getDate() + 1);
                    // Sets the date to tomorrow by adding 1
                   let formattedDate = $.datepicker.formatDate('yy-mm-dd', new Date(date.getFullYear(), date.getMonth(), date.getDate()));
                    // Format the date to YYYY-MM-DD
                    $('#reminderInput').val(formattedDate);
                     // Sets the value of the reminder input to formatted date
                     $('#reminderTimeLabel').text($.datepicker.formatDate('D, M dd yy', new Date(formattedDate)));
                    // Set the text of the label to formatted date using Jquery UI date format
                 }
                 if(selectedValue == "next_week"){
                     // Check if selected dropdown option value is next week
                     let date = new Date();
                     // Create new date object
                     const dayOfWeek = date.getDay();
                      // Gets the day of the week (0 for Sunday, 1 for Monday etc)
                     const daysUntilMonday = (1 - dayOfWeek + 7) % 7;
                     //Calculate number of days until Monday
                     date.setDate(date.getDate() + daysUntilMonday);
                     // Sets the date to next Monday
                     let formattedDate = $.datepicker.formatDate('yy-mm-dd', new Date(date.getFullYear(), date.getMonth(), date.getDate()));
                     // format the date to YYYY-MM-DD
                    $('#reminderInput').val(formattedDate);
                     // Sets the value of the reminder input to formatted date
                    $('#reminderTimeLabel').text($.datepicker.formatDate('D, M dd yy', new Date(formattedDate)));
                    // Set the text of the label to formatted date using Jquery UI date format

                  }

            });
        }

        // Attach handlers for dropdowns
         // Calling the handleDropdownClick function to attach the event listener on the elements
        handleDropdownClick('.due-date-option', '#dueDateInput', '#dueDateLabel');
        handleDropdownClick('.reminder-option', '#reminderInput', '#reminderTimeLabel');
        handleDropdownClick('.recurrence-option', '#recurrenceInput', '#recurrenceLabel');
        handleDropdownClick('.list-name-option', '#listNameInput', '#listNameLabel');

        // Image preview functionality
        $('#images').on('change', function () {
          // Event listener to capture change event on image input field
            const imagePreviews = $('#image-previews').empty();
            // Clear the image previews
            Array.from(this.files).forEach(file => {
                // Loops through all selected images
                const reader = new FileReader();
                // Creates new file reader object
                reader.onload = function (e) {
                    // Executes a function when file is loaded
                    $('<img>', {
                        src: e.target.result,
                        // sets the source of the image element to loaded image
                        class: 'img-thumbnail',
                         // sets the class of image to img-thumbnail
                    }).appendTo(imagePreviews);
                     // appends the image element to image preview
                };
                reader.readAsDataURL(file);
                  // reads the file and creates data url
            });
        });
    });
</script>